---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection, render } from 'astro:content';

const allPosts = (await getCollection('blog', ({ data }) => {
  return import.meta.env.PROD ? data.draft !== true : true;
})).sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Render each post to get reading time from remark plugin
const posts = await Promise.all(
  allPosts.map(async (post) => {
    const { remarkPluginFrontmatter } = await render(post);
    return { ...post, readingTime: remarkPluginFrontmatter.readingTime as string };
  })
);

function formatDate(date: Date): string {
  return date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
  });
}
---

<BaseLayout title="Blog - Logan Reeder" description="Blog posts by Logan Reeder">
  <div class="prose mx-6 dark:prose-dark">
    <h1>Blog</h1>
    {posts.length === 0 ? (
      <p class="text-muted-foreground">No posts yet. Check back soon.</p>
    ) : (
      <ul class="not-prose list-none pl-0">
        {posts.map((post) => (
          <li class="border-b border-border py-4 first:pt-0 last:border-b-0">
            <a href={`/blog/${post.id}`} class="group block no-underline">
              <div class="flex items-baseline justify-between gap-4">
                <h2 class="text-lg font-bold text-foreground group-hover:text-primary transition-colors">
                  {post.data.title}
                </h2>
                <time
                  datetime={post.data.pubDate.toISOString()}
                  class="shrink-0 text-sm text-muted-foreground"
                >
                  {formatDate(post.data.pubDate)}
                </time>
              </div>
              <p class="mt-1 text-sm text-muted-foreground">
                {post.data.description}
              </p>
              {post.data.tags && post.data.tags.length > 0 && (
                <div class="mt-2 flex gap-2">
                  {post.data.tags.map((tag) => (
                    <span class="rounded-sm bg-secondary px-2 py-0.5 text-xs font-medium text-secondary-foreground">
                      {tag}
                    </span>
                  ))}
                </div>
              )}
            </a>
          </li>
        ))}
      </ul>
    )}
  </div>
</BaseLayout>
